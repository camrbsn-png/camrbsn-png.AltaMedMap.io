<!DOCTYPE html>
<html lang="en">
<head>

<link rel="icon" type="image/svg+xml" href="icon.svg">
<link rel="apple-touch-icon" href="icon.svg">

<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="LexiGlobal">

<style>
    :root {
        --sat: env(safe-area-inset-top);
        --sar: env(safe-area-inset-right);
        --sab: env(safe-area-inset-bottom);
        --sal: env(safe-area-inset-left);
    }
</style>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>LexiGlobal Directory</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <style>
        :root { 
            --lexi-blue: #0984e3;
            --lexi-turquoise: #1abc9c; 
            --pace-purple: #9b59b6;
            --admin-gray: #2d3436;
            --pickup-orange: #e67e22;
            --hospital-red: #e74c3c;
        }
        
    html, body { 
        height: 100%; 
        height: 100dvh; 
        width: 100%; 
        margin: 0; 
        padding: 0; 
        overflow: hidden; 
        position: fixed; 
    }
    body { 
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; 
        display: flex; 
        flex-direction: row; 
    }
    
    #sidebar { width: 350px; min-width: 350px; background: #fff; z-index: 9999; display: flex; flex-direction: column; box-shadow: 2px 0 15px rgba(0,0,0,0.1); transition: transform 0.3s ease; }
    #map-container { flex-grow: 1; position: relative; height: 100%; }
    #map { height: 100%; width: 100%; background: #f0f0f0; }

    @media (max-width: 1024px) {
        #sidebar { position: absolute; left: 0; top: 0; height: 100%; width: 85%; max-width: 320px; transform: translateX(0); }
        #sidebar.closed { transform: translateX(-100%); }
    }

    #filter-section { padding: 15px; background: #f8f9fa; border-bottom: 1px solid #eee; }
    .filter-row { display: flex; gap: 5px; flex-wrap: wrap; margin-bottom: 8px; }
    .filter-chip { display: flex; align-items: center; gap: 4px; font-size: 0.75rem; cursor: pointer; background: white; padding: 6px 10px; border-radius: 20px; border: 1px solid #ddd; }
    .filter-chip:has(input:checked) { background: var(--lexi-blue); color: white; border-color: var(--lexi-blue); }
    .filter-chip input { display: none; }

    #search-sticky-section { padding: 15px; background: white; border-bottom: 1px solid #eee; }
    .search-box { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; font-size: 16px; box-sizing: border-box; }

    .content { overflow-y: auto; flex-grow: 1; display: none; }
    .list-item { padding: 16px; border-bottom: 1px solid #f0f0f0; cursor: pointer; }
    .list-item:hover { background: #f8f9fb; border-left: 4px solid var(--lexi-blue); }

    .custom-pin { display: flex; align-items: center; justify-content: center; border-radius: 50% 50% 50% 0; border: 2px solid white; box-shadow: 0 2px 5px rgba(0,0,0,0.3); color: white; width: 35px; height: 35px; transform: rotate(-45deg); }
    .pin-content { transform: rotate(45deg); font-size: 1.2rem; }

    /* FIXED: Positioned slightly higher and added safe-area-inset */
    #control-panel { 
        position: absolute; 
        bottom: 15px; /* Base lift from the bottom */
        right: 15px; 
        z-index: 8000; 
        display: flex; 
        flex-direction: column; 
        gap: 10px; 
        padding-bottom: env(safe-area-inset-bottom); /* Specifically for iPhone home bar */
    }
    .btn { padding: 14px; border: none; border-radius: 12px; font-weight: 700; color: white; box-shadow: 0 6px 15px rgba(0,0,0,0.3); width: 140px; cursor: pointer; }
</style>
</head>
<body>

<div id="sidebar">
    <div style="background:var(--lexi-blue); color:white; padding:20px; display:flex; justify-content:space-between; align-items:center;">
        <h2 style="margin:0; font-size:1.2rem;">LexiGlobal Directory</h2>
        <span onclick="toggleSidebar()" style="cursor:pointer; font-size:1.5rem;" class="mobile-only">‚úï</span>
    </div>

    <div id="filter-section">
        <small style="font-weight:bold; display:block; margin-bottom:8px;">MAIN DIRECTORIES</small>
        <div class="filter-row">
            <label class="filter-chip"><input type="checkbox" class="company-filter" value="AltaMed" onchange="toggleFilterState()"> AltaMed</label>
            <label class="filter-chip"><input type="checkbox" class="company-filter" value="Pickup/Deliveries" onchange="toggleFilterState()"> Pickup/Deliveries</label>
            <label class="filter-chip"><input type="checkbox" class="company-filter" value="East Valley" onchange="toggleFilterState()"> East Valley</label>
            <label class="filter-chip"><input type="checkbox" class="company-filter" value="San Antonio Regional Hospital" onchange="toggleFilterState()"> San Antonio</label>
        </div>

        <div id="altamed-sub-section" style="display:none; margin-top:15px; padding-top:10px; border-top:1px dashed #ccc;">
            <small style="color:var(--lexi-turquoise); font-weight:bold; display:block; margin-bottom:8px;">ALTAMED CATEGORIES</small>
            <div class="filter-row">
                <label class="filter-chip"><input type="checkbox" class="cat-filter" value="Medical" checked onchange="updateMap()"> Medical</label>
                <label class="filter-chip"><input type="checkbox" class="cat-filter" value="PACE" checked onchange="updateMap()"> PACE</label>
                <label class="filter-chip"><input type="checkbox" class="cat-filter" value="Admin" checked onchange="updateMap()"> Admin</label>
            </div>
        </div>
    </div>

    <div id="search-sticky-section">
        <input type="text" id="site-search" class="search-box" placeholder="Search..." onkeyup="updateMap()">
    </div>

    <div class="content" id="sidebar-list">
        <div id="location-list"></div>
    </div>
</div>

<div id="map-container">
    <div id="map"></div>
    <div id="control-panel">
        <button class="btn" style="background:var(--pickup-orange)" onclick="resetLocations()">üóëÔ∏è Clear Cache</button>
        <button class="btn" style="background:#636e72" onclick="toggleSatellite()">üõ∞Ô∏è Satellite</button>
        <button id="loc-btn" class="btn" style="background:#6c5ce7" onclick="locateUser()">üìç Find Me</button>
        <button class="btn" style="background:var(--lexi-blue)" onclick="toggleSidebar()">üìÇ Menu</button>
    </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="locations.js"></script>

<script>
    let markers = [];
    let userLatLng = null;
    const streetLayer = L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png');
    const satLayer = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}');
    const map = L.map('map', { zoomControl: false, layers: [streetLayer] }).setView([34.0522, -118.2437], 10);

    map.on('mousedown', function() {
        if (window.innerWidth <= 1024) {
            document.getElementById('sidebar').classList.add('closed');
        }
    });

    function toggleSidebar() {
        document.getElementById('sidebar').classList.toggle('closed');
    }

    function getCustomIcon(loc) {
        let color = '#1abc9c';
        let icon = 'üè•';
        if (loc.company === 'Pickup/Deliveries') { color = '#e67e22'; icon = 'üì¶'; }
        else if (loc.company === 'East Valley') { color = '#e74c3c'; icon = 'üè®'; }
        else if (loc.company === 'San Antonio Regional Hospital') { color = '#2980b9'; icon = 'üè•'; }
        else if (loc.cat === 'PACE') { color = '#9b59b6'; icon = 'üëµ'; }
        else if (loc.cat === 'Admin') { color = '#2d3436'; icon = 'üè¢'; }

        return L.divIcon({
            className: 'custom-marker',
            html: `<div class="custom-pin" style="background:${color}"><div class="pin-content">${icon}</div></div>`,
            iconSize: [35, 35],
            iconAnchor: [17, 35]
        });
    }

    function toggleFilterState() {
        const checkedCompanies = Array.from(document.querySelectorAll('.company-filter:checked')).map(cb => cb.value);
        document.getElementById('altamed-sub-section').style.display = checkedCompanies.includes("AltaMed") ? 'block' : 'none';
        document.getElementById('sidebar-list').style.display = checkedCompanies.length > 0 ? 'block' : 'none';
        updateMap();
    }

    function getOpenStatus(openTime, closeTime) {
        if (!openTime || !closeTime) return "";
        const now = new Date();
        const currentTime = now.getHours() * 100 + now.getMinutes();
        const [openH, openM] = openTime.split(':').map(Number);
        const [closeH, closeM] = closeTime.split(':').map(Number);
        const openVal = openH * 100 + openM;
        const closeVal = closeH * 100 + closeM;
        const isOpen = currentTime >= openVal && currentTime < closeVal;
        return isOpen ? 
            `<span style="color:var(--lexi-turquoise); font-weight:bold;">‚óè Open</span> <span style="font-size:0.8em; color:#666;">(Closes ${closeTime})</span>` : 
            `<span style="color:var(--hospital-red); font-weight:bold;">‚óã Closed</span> <span style="font-size:0.8em; color:#666;">(Opens ${openTime})</span>`;
    }

    function updateMap() {
        markers.forEach(m => map.removeLayer(m));
        markers = [];
        const listContainer = document.getElementById('location-list');
        listContainer.innerHTML = '';
        const searchQuery = document.getElementById('site-search').value.toLowerCase();
        const checkedCompanies = Array.from(document.querySelectorAll('.company-filter:checked')).map(cb => cb.value);
        const checkedCats = Array.from(document.querySelectorAll('.cat-filter:checked')).map(cb => cb.value);

        if (checkedCompanies.length === 0 || typeof defaultLocations === 'undefined') return;

        let filtered = defaultLocations.filter(loc => {
            const matchesCompany = checkedCompanies.includes(loc.company);
            const matchesCat = loc.company !== "AltaMed" || checkedCats.includes(loc.cat);
            const matchesSearch = loc.name.toLowerCase().includes(searchQuery) || loc.addr.toLowerCase().includes(searchQuery);
            return matchesCompany && matchesCat && matchesSearch;
        });

        if (userLatLng) {
            filtered.sort((a, b) => map.distance(userLatLng, [a.lat, a.lng]) - map.distance(userLatLng, [b.lat, b.lng]));
        }

        filtered.forEach(loc => {
            const statusHtml = getOpenStatus(loc.open, loc.close);
            const dist = userLatLng ? (map.distance(userLatLng, [loc.lat, loc.lng]) * 0.000621371).toFixed(1) + " mi" : "";
            const servicesText = loc.services ? loc.services.join(', ') : '';

            // 1. Map Marker & Popup
            const m = L.marker([loc.lat, loc.lng], { icon: getCustomIcon(loc) }).addTo(map);
            
            m.bindPopup(`
                <div style="font-family: sans-serif; min-width:200px; padding:5px;">
                    <strong style="font-size:1.1em; color:var(--lexi-blue);">${loc.name}</strong><br>
                    <div style="font-size:0.85em; font-weight:bold; color:#444; margin-bottom:4px;">${loc.cat} ${servicesText ? '‚Ä¢ ' + servicesText : ''}</div>
                    <div style="margin: 4px 0;">${statusHtml}</div>
                    <div style="color:#666; margin-bottom:8px; font-size:0.9em;">${loc.addr}</div>
                    <hr style="border:0; border-top:1px solid #eee; margin:10px 0;">
                    <a href="https://www.google.com/maps/dir/?api=1&destination=${loc.lat},${loc.lng}" 
                       target="_blank" 
                       style="display:block; text-align:center; background:var(--lexi-blue); color:white; padding:10px; border-radius:8px; text-decoration:none; font-weight:bold; box-shadow: 0 2px 5px rgba(0,0,0,0.1);">
                       üöó Get Directions ${dist ? '('+dist+')' : ''}
                    </a>
                </div>
            `);
            markers.push(m);

            // 2. Sidebar List Item
            const div = document.createElement('div');
            div.className = 'list-item';
            div.innerHTML = `
                <div style="display:flex; justify-content:space-between; align-items:flex-start;">
                    <strong style="color:var(--lexi-blue);">${loc.name}</strong>
                    <span style="font-size:0.8em; color:var(--lexi-blue); font-weight:bold;">${dist}</span>
                </div>
                <div style="font-size:0.75em; font-weight:bold; color:#555; margin: 2px 0;">${loc.cat} ${servicesText ? '‚Ä¢ ' + servicesText : ''}</div>
                <small style="color:#666;">${loc.addr}</small><br>
                <div style="margin-top:4px;">${statusHtml}</div>
            `;
            div.onclick = () => {
                map.flyTo([loc.lat, loc.lng], 15);
                m.openPopup();
                if (window.innerWidth <= 1024) toggleSidebar(); 
            };
            listContainer.appendChild(div);
        });
    }

    function resetLocations() {
        if(confirm("Clear cache and reset data?")) {
            localStorage.removeItem('altamed_locations');
            location.reload();
        }
    }

    function toggleSatellite() {
        if (map.hasLayer(streetLayer)) { map.removeLayer(streetLayer); map.addLayer(satLayer); }
        else { map.removeLayer(satLayer); map.addLayer(streetLayer); }
    }

    function locateUser() {
        map.locate({setView: true, maxZoom: 14});
        map.on('locationfound', (e) => { userLatLng = e.latlng; updateMap(); });
    }

    window.onload = toggleFilterState;
</script>
</body>
</html>
